# TM25_Dash-Datalogger
This repository will outline the background and design decisions associated with the display/datalogger module on the TM25 Formula SAE vehicle.  
## Background
TM25 has two main modules (the motor controller and the battery management system) that are capable of communicating various information about themselves, as well as having the ability of being controlled via a CANbus line. 
This design aims to read the CANbus and to decode the various information that the these systems can transmit. Furthermore, the information is to be shown on a display and logged onto an SD card. Future development can
include the wireless transmission of this information to a base station for real-time analysis from outside the car. For this implementation, a Teensy 4.1 is used as it has an SD card slot built in, and supports
all the required functionality.
## Design
### Vehicle Display  
The display that is used on the vehicle is a Nextion NX8048T050. This is a 5" display capable of interfacing with an Arduino/Teensy via its serial ports and has touchscreen functionality. Nextion an editor software: 
https://nextion.tech/editor_guide/ for the development of the UI for the display. The UI gets uploaded to the display and various fields/values get updated from the controller (Teensy in the case). The display 
can be programmed with the UI by inserting a microSD card with the UI file generated by the Nextion Editor. Note that the SD card must be formatted as FAT32. DiskGenius is a software that is capable of this
since by default Windows 10 does not support formatting of a device in FAT32. A version of the created UI can be seen below. Key information that is displayed to the driver includes the vehicle speed, battery state of 
charge, battery temperatures, motor and motor controller temperatures,
and power output.  

![Display UI](/Images/Display_GUI.png)  
## Teensy Display Controller
In order for the Teensy 4.1 to easily interface with the Nextion display, the EasyNextionLibrary: https://github.com/Seithan/EasyNextionLibrary needs to be imported. As mentioned above, through this library you
can update the fields/values present on the pre-generated UI on the display. The Teensy 4.0 can communicate with the display via any serial ports, they just need to be properly configured in the code. 
## Interfacing the CANbus
In order to decode the information that is transmitted by the motor and motor controller the CANbus messages need to be decoded in accordancy to the way that these devices transmit data. A CANbus
transciever needs to be placed between the available CANbus ports of the Teensy and the CANbus line. The motor controller is a DTI HV-500 and the associated CANbus manual is of version 2.3. All the data that is transmitted
is hardcoded into set addresses and explained in the manual (with the exception of the device ID that can be varied). For example, in order to read the input DC current, this parameter is sent in bytes 2-3 on address 0x0151. 
The "01" portion is associated with the actual message and is hardcoded, and the "51" portion is the motorcontroller's ID which is 81, or 51 in hexadecimal. The ID can be changed to a range of values if required. The 
battery management system (BMS) is somewhat more confusing because the data and the address on which it is transmitted can be completed configured by the user. The current message configuration is shown in the image below. 
To decode each of the messages sent by the BMS, Appendix B should be referenced in the Orion BMS manual: https://www.orionbms.com/manuals/utility_o2/. The CANbus baud rate is configured to 500kbit/s and the FlexCAN_T4 
library (https://github.com/tonton81/FlexCAN_T4) is used by the Teensy 4.1 to send/recieve messages.  

![BMS CANbus Messages](/Images/BMS_CANbus_messages.png)
## Logging Data onto a MicroSD Card
All information that is decoded from the CANbus is written to a MicroSD card in the form of .csv files that can be easily reviewed and analyzed in Excel. Each file is individually numbered and reach entry in the files has an associated timestamp with the time since the Teensy 4.1 booted up.
## Difficulties Experienced
1. If the values on the display are updated every single time that a message is recieved from the CANbus, for some reason a significant delay of ~2 seconds develops. The way that this issue was overcome is that the display gets updated once every 100 recieved messages. This eliminated the delay that was experienced and still provides relevant data in a timely manner. 
2. When the Orion BMS 2 measures temperatures from Enepaq battery modules (which is the case here), the second that the modules experience discharge, all temperature readings are lost and the BMS stays in a state where it no longer records any battery temperatures. This is quite unacceptable in an electric vehicle. Fortunately, this shortcoming was somewhat overcome by directly reading the information sent by the thermistor expansion module that reads the temperatures for the BMS. Once the modules stop experiencing discharge (like in a braking zone) the thermistor expansion module begins sending individual Enepaq module temperatures on address 0x1838F380 in bytes 1 and 2. Byte 1 transmits the thermistor number and byte 2 transmitts the associated temperature. Reading this information directly from the thermistor expansion module address ensures that battery temperatures are known.

## Future Additions
